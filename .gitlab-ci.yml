stages:
  - test
  - build
  - dist
  - release
  - deploy

.authenticate_tracker: &authenticate_tracker
  before_script:
    - echo "machine tracker.parsys.com" > ~/.netrc
    - echo "login gitlab-ci-token" >> ~/.netrc
    - echo "password ${CI_JOB_TOKEN}" >> ~/.netrc

variables:
  CONTAINER_TEST_IMAGE: tracker.parsys.com:1337/parsys/asset_tracker:$CI_BUILD_REF_NAME
  CONTAINER_RELEASE_IMAGE: tracker.parsys.com:1337/parsys/asset_tracker:latest
  PIP_CACHE_DIR: $CI_PROJECT_DIR/.cache/pip

flake8:
  <<: *authenticate_tracker
  stage: test
  image: python:3.6
  tags:
    - docker

  cache:
    key: ${CI_PROJECT_ID}
    paths:
      - .cache/pip

  script:
    - pip3 install -q -U pip setuptools wheel
    - pip3 -q install '.[qa]'
    - flake8 --exclude asset_tracker/tests/a_porter

pytest:
  <<: *authenticate_tracker
  stage: test
  image: python:3.6
  tags:
    - docker

  cache:
    key: ${CI_PROJECT_ID}
    paths:
      - .cache/pip
    policy: pull

  script:
    - pip3 install -q -U pip setuptools wheel
    - pip3 -q install '.[tests]'
    - py.test --cov=asset_tracker

build:
  <<: *authenticate_tracker
  stage: build
  image: python:3.6
  tags:
    - docker

  cache:
    key: ${CI_PROJECT_ID}
    paths:
      - .cache/pip
    policy: pull

  script:
    - pip3 install -q -U pip setuptools wheel
    - python3 setup.py bdist_wheel
    - pip3 wheel -w dist/ .

  artifacts:
    name: $CI_BUILD_NAME_$CI_BUILD_REF_NAME
    expire_in: 6 hours
    paths:
      - dist/

docker-image:
  stage: dist
  tags:
    - shell

  script:
    - echo creating $CONTAINER_TEST_IMAGE
    - docker build -t $CONTAINER_TEST_IMAGE .

release-image:
  stage: release
  tags:
    - shell

  script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN tracker.parsys.com:1337
    - docker push $CONTAINER_TEST_IMAGE

release-latest-image:
  stage: release
  tags:
    - shell
  only:
    - master

  script:
    - docker tag $CONTAINER_TEST_IMAGE $CONTAINER_RELEASE_IMAGE
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN tracker.parsys.com:1337
    - docker push $CONTAINER_RELEASE_IMAGE

deploy_dev:
  stage: deploy
  tags:
    - shell
  only:
    - develop

  script:
    - ssh root@at.dev.parsys.com parsys upgrade at.dev.parsys.com

  environment:
    name: dev
    url: https://at.dev.parsys.com

deploy_staging:
  stage: deploy
  tags:
    - shell
  only:
    - master

  script:
    - ssh root@at.cloud.staging.parsys.com parsys upgrade at.cloud.staging.parsys.com

  environment:
    name: staging
    url: https://at.cloud.staging.parsys.com

deploy_staging_marlink:
  stage: deploy
  tags:
    - shell
  only:
    - master

  script:
    - ssh root@asset.pp.telemed.marlink.com parsys upgrade asset.pp.telemed.marlink.com

  environment:
    name: staging_marlink
    url: https://asset.pp.telemed.marlink.com
